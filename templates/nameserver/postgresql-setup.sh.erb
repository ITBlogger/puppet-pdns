#!/bin/bash
service postgresql initdb
service postgresql start
chkconfig postgresql on
sudo -H -u postgres createdb powerdns
sudo -H -u postgres psql powerdns < /etc/pdns/schema.sql
SQL_FILE=$(mktemp '/tmp/postgres-setup.XXXXXXXXXX')
echo "CREATE USER pdns PASSWORD '<%= scope.lookupvar("pdns::nameserver::db_password") %>';" > $SQL_FILE
echo "GRANT SELECT ON supermasters TO pdns;" >> $SQL_FILE
echo "GRANT ALL ON domains TO pdns;" >> $SQL_FILE
echo "GRANT ALL ON domains_id_seq TO pdns;" >> $SQL_FILE
echo "GRANT ALL ON records TO pdns;" >> $SQL_FILE
echo "GRANT ALL ON records_id_seq TO pdns;" >> $SQL_FILE
sudo -H -u postgres psql powerdns < $SQL_FILE
rm -f $SQL_FILE
