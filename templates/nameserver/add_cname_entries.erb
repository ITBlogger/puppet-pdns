#!/usr/bin/perl
use DBI;
use warnings;
use strict;

my $domain = '<%= scope.lookupvar('pdns::nameserver::config::forward_domain') %>';

<% if scope.lookupvar('pdns::nameserver::config::backend') == 'sqlite' -%>
# SQLite
my $dbh = DBI->connect("dbi:SQLite:dbname=/var/pdns/powerdns.sqlite", "", "");
<% elsif scope.lookupvar('pdns::nameserver::config::backend') == 'postgresql' -%>
# Posgresql
my $dbh = DBI->connect("dbi:Pg:dbname=powerdns", "", "", {AutoCommit => 1})
  or die DBI->err;
<% end -%>

# Get id for domain (eg. 'local')
my ($domain_id) =
  $dbh->selectrow_array("SELECT id FROM domains WHERE name='$domain'");

# Add CNAME entry - input: alias, hostname
my $sth_insert_CNAME =
  $dbh->prepare("INSERT INTO records (domain_id, name, type, content, ttl, prio) VALUES($domain_id,?,'CNAME',?,3600,NULL)");

# Get CNAME entry - input: alias; output: hostname
my $sth_select_CNAME =
  $dbh->prepare("SELECT content from records where domain_id='$domain_id' AND name=? AND type='CNAME'");

while(<>) {
  chomp;
  my ($alias, $type, $host) = split(/\s+/, $_, 3);
  my ($current_alias, $current_host);

  unless ($alias and $type and $host) {
    warn "Bad input: $_\n";
    next;
  }

  unless ($alias =~ /^(.*?)\./) {
    $alias .= '.' . $domain;
  }
  unless ($host =~ /^(.*?)\./) {
    $host .= '.' . $domain;
  }

  # Get CNAME entry - input: alias; output: hostname
  $sth_select_CNAME->execute($alias) or die;
  ($current_host) = $sth_select_CNAME->fetchrow_array;

  print "Adding CNAME record: alias $alias, host $host: ";
  if ($current_host) {
    if ($current_host eq $host) {
      print "already exists\n";
    }
    else {
      print "existing CNAME record for alias $alias with different host $current_host\n";
    }
  }
  else {
    print "ok\n";
    # Add CNAME entry - input: alias, hostname
    $sth_insert_CNAME->execute($alias, $host) or die;
  }
}
